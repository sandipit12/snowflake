SET NOCOUNT ON;
/*
Notes:
1. Use double quotes instead of single quotes.
*/
SELECT 
       [PK_LoanRequest]
      ,[CreateDate]
      ,[UpdateDate]
      ,[Amount]
      ,[Term]
      ,[Purpose]
      ,CHAR(34) + REPLACE(REPLACE([PurposeOther],CHAR(34), "\" + CHAR(34)),CHAR(9),"    ") + CHAR(34)
      ,[RequestStatus]
      ,[AdminUser]
      ,[CreditRate]
      ,[CreditStatus]
      ,[OriginalAmount]
      ,[OriginalTerm]
      ,[SuggestedPass]
      ,[AppComplete]
      ,[CompletionDate]
      ,[RequestSource]
      ,[SharingOptIn]
      ,[RequestType]
      ,[FK_ConsolidationLoan]
      ,[FeeRebate]
      ,[CRAdjustment]
      ,[ApprovalDate]
      ,[FacilityAmount]
      ,[FacilityDate]
      ,[LoanSecurity]
      ,[BaseRate]
      ,[SecondaryRate]
      ,[DocumentGUID]
      ,[RequestGUID]
      ,[CreditQueue]
      ,[FeeType]
      ,[LoanFeeRebate]
      ,[AffiliateFee]
      ,[AffiliateFeeRebate]
      ,[CategoryFee]
      ,[LoanFee]
      ,[FixedAPR]
      ,[LockApprovalTerm]
      ,[OriginatingRequest]
      ,[FK_AutoApproval_RuleSet]
      ,[UnderwritingStatus]
      ,[FirstContact]
      ,[FirstContactDate]
      ,[FirstContactStaff]
      ,[FirstContactRequestStatus]
      ,[FirstContactCreditStatus]
      ,[TargetFirstContactDate]
      ,[CreditDecision]
      ,[ReasonForCancellation]
      ,[LoanPurpose]
      ,[CreditCategory]
      ,[CreditCategoryID]
      ,[InboundCalls]
      ,[CreditFee]
      ,[Repayment_monthly]
      ,[Repayment_total]
      ,[DirectDebitDay]
      ,[LoanRepaymentType]
      ,[FK_PrimaryUserID]
      ,[RSInterestRate]
      ,[BorrowerInterestRate]
      ,[DirectDebitMonth]
      ,[ThirdPartyAllocation]
      ,[APRType]
      ,[BusinessSector]
      ,[BusinessSubSector]
      ,[BusinessLoanUse]
      ,[PaymentCreditRate]
      ,[ContractsSeen]
      ,[LoanNumber]
      ,[UserDDDay]
      ,[ContractSignedDate]
      ,[UserDDMonth]
      ,[FundingSource]
      ,[FundingRate]
      ,[PreDivertAPR]
      ,CHAR(34) + REPLACE(REPLACE([TrackingSource],CHAR(34), "\" + CHAR(34)),CHAR(9),"    ") + CHAR(34)
      ,[TrackingPromo]
      ,[TrackingCreative]
      ,[FK_AffiliateSubAccount]
      ,[RetailDeposit]
      ,[DepositFee]
      ,[OutPaymentFee]
      ,[Rate_Borrower]
      ,[Rate_Funding]
      ,[Rate_Credit]
      ,[Rate_Service]
      ,[Rate_CostOfFunds]
      ,[Rate_Swap]
      ,[Rate_SwapAdjustment]
      ,[Rate_Partner]
      ,[QuoteValidDate]
      ,[ProcessType]
      ,[Commitment_DaysValid]
      ,[LoanSubsidy]
      ,[FacilityCreditStatus]
      ,[ThirdPartyReference]
      ,[CallCreditScore]
      ,[EquifaxScore]
      ,[FundingProductID]
      ,[FK_CarPromotionApplicationID]
      ,[RequirePreApproval]
      ,[PartnerFeeContribution]
      ,[ThirdPartyScore]
      ,[Originator]
      ,[Regulated]
      ,[CommitmentType]
      ,[SubsidyType]
      ,[LoanAgreementType]
      ,[FK_InfoGraphicVersion]
      ,[BrokerDeclarationAccepted]
      ,[ConfirmBrokerFormDate]
      ,[SharingSent]
      ,[TotalCreditRateFee]
      ,[LoanFee_Subsidy]
      ,[CreditFactorFee_Subsidy]
      ,[ThirdPartyName]
      ,[PreApproved]
      ,CHAR(34) + REPLACE(REPLACE([BusinessSectorDescription],CHAR(34), "\" + CHAR(34)),CHAR(9),"    ") + CHAR(34)      
      ,[ChangeInCircumstances]
      ,[IntroducerFee]
      ,[IntroducerFeeRebate]
      ,[SecurityProvided]
      ,[IsReApplication]
      ,[QuoteAffordabilityApprove]
      ,[AffordabilityApprove]
      ,[DecisionRoute]
      ,[DocumentFee]
      ,[PurchaseFee]
      ,[UseRolling]
      ,[DaysBeforeFirstPayment]
      ,[Channel]
      ,[PricingChannel]
      ,[ApolloRoute]
      ,[LoanFeesId]
/* metadata colums -- should not incldue in the hash_key */
      ,@@ServerName as Source_System
      ,convert(date, getdate()) as Snapshot_Date
/*--------------------------------------------------------------------
-- derived business key
-------------------------------------------------------------------- */
     ,HASHBYTES("SHA2_256",
        CONCAT_WS("|",
        [PK_LoanRequest]
        ,[CreateDate]
        ,[UpdateDate]
        ,[Amount]
        ,[Term]
        ,[Purpose]
        ,[PurposeOther]
        ,[RequestStatus]
        ,[AdminUser]
        ,[CreditRate]
        ,[CreditStatus]
        ,[OriginalAmount]
        ,[OriginalTerm]
        ,[SuggestedPass]
        ,[AppComplete]
        ,[CompletionDate]
        ,[RequestSource]
        ,[SharingOptIn]
        ,[RequestType]
        ,[FK_ConsolidationLoan]
        ,[FeeRebate]
        ,[CRAdjustment]
        ,[ApprovalDate]
        ,[FacilityAmount]
        ,[FacilityDate]
        ,[LoanSecurity]
        ,[BaseRate]
        ,[SecondaryRate]
        ,[DocumentGUID]
        ,[RequestGUID]
        ,[CreditQueue]
        ,[FeeType]
        ,[LoanFeeRebate]
        ,[AffiliateFee]
        ,[AffiliateFeeRebate]
        ,[CategoryFee]
        ,[LoanFee]
        ,[FixedAPR]
        ,[LockApprovalTerm]
        ,[OriginatingRequest]
        ,[FK_AutoApproval_RuleSet]
        ,[UnderwritingStatus]
        ,[FirstContact]
        ,[FirstContactDate]
        ,[FirstContactStaff]
        ,[FirstContactRequestStatus]
        ,[FirstContactCreditStatus]
        ,[TargetFirstContactDate]
        ,[CreditDecision]
        ,[ReasonForCancellation]
        ,[LoanPurpose]
        ,[CreditCategory]
        ,[CreditCategoryID]
        ,[InboundCalls]
        ,[CreditFee]
        ,[Repayment_monthly]
        ,[Repayment_total]
        ,[DirectDebitDay]
        ,[LoanRepaymentType]
        ,[FK_PrimaryUserID]
        ,[RSInterestRate]
        ,[BorrowerInterestRate]
        ,[DirectDebitMonth]
        ,[ThirdPartyAllocation]
        ,[APRType]
        ,[BusinessSector]
        ,[BusinessSubSector]
        ,[BusinessLoanUse]
        ,[PaymentCreditRate]
        ,[ContractsSeen]
        ,[LoanNumber]
        ,[UserDDDay]
        ,[ContractSignedDate]
        ,[UserDDMonth]
        ,[FundingSource]
        ,[FundingRate]
        ,[PreDivertAPR]
        ,[TrackingSource]
        ,[TrackingPromo]
        ,[TrackingCreative]
        ,[FK_AffiliateSubAccount]
        ,[RetailDeposit]
        ,[DepositFee]
        ,[OutPaymentFee]
        ,[Rate_Borrower]
        ,[Rate_Funding]
        ,[Rate_Credit]
        ,[Rate_Service]
        ,[Rate_CostOfFunds]
        ,[Rate_Swap]
        ,[Rate_SwapAdjustment]
        ,[Rate_Partner]
        ,[QuoteValidDate]
        ,[ProcessType]
        ,[Commitment_DaysValid]
        ,[LoanSubsidy]
        ,[FacilityCreditStatus]
        ,[ThirdPartyReference]
        ,[CallCreditScore]
        ,[EquifaxScore]
        ,[FundingProductID]
        ,[FK_CarPromotionApplicationID]
        ,[RequirePreApproval]
        ,[PartnerFeeContribution]
        ,[ThirdPartyScore]
        ,[Originator]
        ,[Regulated]
        ,[CommitmentType]
        ,[SubsidyType]
        ,[LoanAgreementType]
        ,[FK_InfoGraphicVersion]
        ,[BrokerDeclarationAccepted]
        ,[ConfirmBrokerFormDate]
        ,[SharingSent]
        ,[TotalCreditRateFee]
        ,[LoanFee_Subsidy]
        ,[CreditFactorFee_Subsidy]
        ,[ThirdPartyName]
        ,[PreApproved]
        ,[BusinessSectorDescription]
        ,[ChangeInCircumstances]
        ,[IntroducerFee]
        ,[IntroducerFeeRebate]
        ,[SecurityProvided]
        ,[IsReApplication]
        ,[QuoteAffordabilityApprove]
        ,[AffordabilityApprove]
        ,[DecisionRoute]
        ,[DocumentFee]
        ,[PurchaseFee]
        ,[UseRolling]
        ,[DaysBeforeFirstPayment]
        ,[Channel]
        ,[PricingChannel]
        ,[ApolloRoute]
        ,[LoanFeesId]
        )
     ) AS hash_key

  FROM 
    [dbo].[LoanRequests]
  WHERE
    PK_LoanRequest >= 3000000
  ORDER BY 
      PK_LoanRequest;
